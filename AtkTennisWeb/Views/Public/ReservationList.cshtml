@model Helpers.Dto.PartialViewDtos.ReservationListViewDto

@using Microsoft.AspNetCore.Http;
@inject IHttpContextAccessor HttpContextAccessor;


@{
    var fullname = HttpContextAccessor.HttpContext.Session.GetString("FullName");
    var nickname = HttpContextAccessor.HttpContext.Session.GetString("NickName");
    var username = HttpContextAccessor.HttpContext.Session.GetString("UserName");
    var userId = HttpContextAccessor.HttpContext.Session.GetString("UserId");
}

@{
    var totalPrice = 0;

    var newModel = Model.reservations.Where(x => x.UserId == userId).ToList();

    var date = Model.reservations.Where(x => x.UserId == userId).ToList().OrderByDescending(x => x.ResDate).Select(x => x.ResDate.Split("-")[0]).Distinct().ToList();



    for (int i = 0; i < newModel.Count; i++)
    {
        if (newModel[i].PriceInf == false)
        {
            var firstPrice = newModel[i].Price;
            totalPrice = firstPrice + totalPrice;
        }

    }

    var debtCount = Model.reservations.Where(x => x.UserId == userId && x.PriceInf == false).Count();
    var debtNotCount = Model.reservations.Where(x => x.UserId == userId && x.PriceInf == true).Count();

}
<div class="content-wrapper">
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">Rezervasyon Listesi</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item active">Reservation List</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <section class="content">
        <div class="container-fluid">
            <div class="card" style="border-radius:40px">
                <div class="card-content">
                    <div class="card-body cleartfix">
                        <div class="media align-items-stretch">
                            <div class="align-self-center">
                                <i style="font-size:60px; margin-right:20px ; color:darkmagenta" class="fas fa-id-card"></i>
                            </div>
                            <div class="media-body">
                                <h4>@fullname - @nickname</h4>
                                <span>@username</span>
                            </div>



                            <div class="align-self-center">
                                <h3>Toplam Borç: @totalPrice ₺<i style="font-size:25px; margin-left:10px ; color:darkmagenta" class="fas fa-tags"></i></h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-info">
                        <div class="inner">
                            <h3>@debtCount</h3>
                            <p>Ödenmeyen Rezervasyonlar</p>
                        </div>
                        <div class="icon">
                            <i class="far fa-window-close"></i>
                        </div>
                    </div>
                </div>

                <div class="col-lg-3 col-6">
                    <div class="small-box bg-success">
                        <div class="inner">
                            <h3>@debtNotCount</h3>

                            <p>Ödeme Yapılan Rezervasyonlar</p>
                        </div>
                        <div class="icon">
                            <i class="far fa-check-square"></i>
                        </div>
                    </div>
                </div>

                <div class="col-lg-3 col-6">
                    <div class="small-box bg-warning">
                        <div class="inner">
                            <h3>44</h3>

                            <p>İptal Edilen Rezervasyonlar</p>
                        </div>
                        <div class="icon">
                            <i class="far fa-bell-slash"></i>
                        </div>
                    </div>
                </div>

                <div class="col-lg-3 col-6">
                    <div class="small-box bg-danger">
                        <div class="inner">
                            <h3>@totalPrice ₺</h3>

                            <p>Toplam Borç</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-money-check-alt"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>



    <section class="content">
        <div class="container-fluid">

            @for (int i = 0; i < date.Count; i++)
            {
                <div class="card">
                    <div class="card-header d-flex justify-content-between">
                        <div class="card-title">
                            <h3>@date[i] Yılına Ait Rezervasyonlar</h3>
                        </div>

                    </div>

                    <div class="card-body">
                        <table id="example2" style="border-collapse:inherit" class="table table-bordered table-hover">
                            <thead>
                                <tr style="text-align:center">
                                    <th>Tarih</th>
                                    <th>Saat</th>
                                    <th>Kort Bilgisi</th>
                                    <th>Ücret Detayı</th>
                                    <th>Ücret Durumu</th>
                                    <th>Durumu</th>
                                    <th>İşlemler</th>


                                </tr>
                            </thead>
                            <tbody>

                                @foreach (var item in Model.reservations)
                                {
                                    if (item.UserId == userId)
                                    {
                                        if (item.ResDate.Split("-")[0] == date[i])
                                        {
                                            <tr style="text-align:center" id="">
                                                <td>@item.ResDate</td>
                                                <td>@item.ResStartTime - @item.ResFinishTime</td>
                                                <td>@item.Court.CourtName</td>
                                                <td>@item.Price ₺</td>

                                                @if (item.PriceInf == false)
                                                {
                                                    <td>Ödenmedi</td>
                                                }

                                                else
                                                {
                                                    <td>Ödendi</td>
                                                }

                                                <td>Aktif</td>
                                                <td>
                                                    <button style="color:white; background-color:#17a2b8 ; border-color:#17a2b8" class="btn btn-warning"><i style="margin-right:6px" class="far fa-credit-card"></i>Ödeme</button>
                                                    <button style="color:white" class="btn btn-warning"><i style="margin-right:6px" class="far fa-credit-card"></i>Toplu Ödeme</button>
                                                </td>
                                            </tr>
                                        }
                                    }
                                }

                            </tbody>
                        </table>
                    </div>
                </div>
            }

        </div>
    </section>
    <!-- /.content-wrapper -->
</div>





<script>

    $(document).ready(function () {
        $("#example1").DataTable({
            "responsive": true, "lengthChange": false, "autoWidth": false,
            "buttons": ["copy", "csv", "excel", "pdf", "print", "colvis"]
        }).buttons().container().appendTo('#example1_wrapper .col-md-6:eq(0)');

        $('#example2 , #example3 , #example4').DataTable({
            "paging": true,
            "lengthChange": false,
            "searching": false,
            "ordering": true,
            "info": true,
            "autoWidth": false,
            "responsive": true,
        });


    });
</script>
